<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SUGD BETON</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>

    <style>
        :root { --p: #f97316; --bg: #0f172a; --card: #1e293b; --txt: #f8fafc; --brd: #475569; --s: #22c55e; --sun: #ff0000; }
        body.light { --bg: #f8fafc; --card: #ffffff; --txt: #0f172a; --brd: #cbd5e1; --sun: #ff0000; }
        * { box-sizing: border-box; font-family: 'Segoe UI', sans-serif; transition: 0.2s; }
        body { margin: 0; background: var(--bg); color: var(--txt); font-size: 12px; height: 100vh; display: flex; flex-direction: column; }
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; border:none; border-bottom: 1px solid var(--brd); background: transparent; color: var(--p); font-weight: bold; width: 50px; text-align: center; outline: none; }
        .screen { position: fixed; inset: 0; background: #000; z-index: 1000; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 15px; }
        .hidden { display: none !important; }
        .box { background: var(--card); padding: 30px; border-radius: 16px; border: 1px solid var(--p); text-align: center; width: 340px; box-shadow: 0 10px 40px rgba(0,0,0,0.4); }
        .logo { font-size: 26px; font-weight: 900; color: var(--txt); margin-bottom: 25px; }
        .logo span { color: var(--p); }
        .btn { width: 100%; padding: 14px; border-radius: 10px; border: none; font-weight: bold; cursor: pointer; margin-top: 12px; font-size: 14px; }
        .btn-white { background: #fff; color: #000; }
        .btn-dark { background: #334155; color: #fff; border: 1px solid var(--brd); }
        .btn-orange { background: var(--p); color: #fff; }
        .header { background: var(--card); padding: 8px 12px; display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid var(--p); flex-shrink: 0; gap: 8px; }
        .lang-s { display: flex; gap: 4px; align-items: center; }
        .l-btn { background: var(--brd); padding: 6px 8px; border-radius: 6px; border: none; color: #fff; cursor: pointer; font-size: 11px; font-weight: bold; }
        .l-btn.active { background: var(--p) !important; color: #fff !important; }
        .btn-act { background: #fff; color: #000; border: none; padding: 6px 10px; border-radius: 6px; font-weight: bold; cursor: pointer; font-size: 11px; }
        .date-panel { padding: 8px 12px; display: flex; gap: 8px; background: var(--card); border-bottom: 1px solid var(--brd); flex-shrink: 0; }
        select { flex: 1; background: var(--bg); color: var(--txt); border: 1px solid var(--brd); padding: 6px; border-radius: 6px; outline: none; font-size: 12px; }
        .view { flex: 1; overflow: auto; width: 100%; position: relative; }
        .total-footer { background: var(--p); color: white; padding: 15px; font-weight: bold; text-align: center; border-top: 2px solid var(--brd); font-size: 16px; flex-shrink: 0; z-index: 110; }
        table { border-collapse: separate; border-spacing: 0; width: 100%; }
        thead th { position: sticky; top: 0; background: var(--card); z-index: 50; padding: 10px; border-bottom: 1px solid var(--p); color: var(--txt); font-size: 11px; }
        .cw { position: sticky; left: 0; z-index: 60; width: 150px; background: var(--card); padding: 10px; border-right: 2px solid var(--p); font-weight: bold; line-height: 1.2; }
        .cd { width: 35px; text-align: center; border-right: 1px solid var(--brd); position: relative; }
        .cd.sunday { background-color: rgba(255, 0, 0, 0.35) !important; color: #ff3333 !important; font-weight: bold; }
        thead th.cd.sunday { background-color: #ff0000 !important; color: #ffffff !important; }
        .ct { width: 80px; position: sticky; right: 0; background: var(--card); z-index: 40; border-left: 2px solid var(--p); text-align: center; color: var(--s); font-weight: 900; font-size: 13px; }
        .sq-h { width: 24px; height: 24px; border: 1px solid var(--brd); border-radius: 5px; margin: 3px auto; display: flex; align-items: center; justify-content: center; cursor: pointer; background: var(--bg); font-size: 12px; color: var(--p); font-weight: bold; }
        .sq-h.on { background: var(--s); color: #000; border: none; }
        .sq-h.on::after { content: '‚úì'; }
        .sq-h.off { background: var(--sun); color: #fff; border: none; }
        .sq-h.off::after { content: '‚úï'; font-weight: 900; font-size: 14px; }
        .sq-a { width: 22px; height: 16px; border: 1px dashed var(--p); border-radius: 10px; margin: 3px auto; cursor: pointer; font-size: 9px; color: var(--p); display: flex; align-items: center; justify-content: center; }
        .sq-a.on { background: var(--p); color: #fff; border-style: solid; }
    </style>
</head>
<body id="mainBody">

<div id="screen-login" class="screen">
    <div class="box">
        <div class="logo">SUGD <span>BETON</span></div>
        <button class="btn btn-white" id="btn-google">G Google (–û–±–ª–∞–∫–æ)</button>
        <button class="btn btn-dark" onclick="authLocal()">üíæ –¢–æ–ª—å–∫–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ</button>
    </div>
</div>

<div id="screen-pin" class="screen hidden">
    <div class="box">
        <h3 id="pin-title">–í–≤–µ–¥–∏—Ç–µ PIN</h3>
        <input type="tel" id="pin-input" style="width:100%; font-size:28px; text-align:center; padding:10px; border-radius:8px; border:1px solid var(--brd); background:var(--bg); color:var(--txt);" maxlength="4">
        <button class="btn btn-orange" onclick="checkPin()">–í–•–û–î</button>
    </div>
</div>

<div id="screen-app" class="hidden" style="display: flex; flex-direction: column; height: 100vh;">
    <div class="header">
        <div class="lang-s">
            <button class="l-btn" id="l-ru" onclick="setLang('ru')">RU</button>
            <button class="l-btn" id="l-tj" onclick="setLang('tj')">TJ</button>
            <button class="l-btn" id="l-en" onclick="setLang('en')">EN</button>
            <button class="l-btn" onclick="toggleTheme()" style="background:#475569">üåì</button>
        </div>
        <div class="lang-s">
            <button onclick="genPDF()" class="btn-act">PDF</button>
            <button onclick="addW()" class="btn-act" style="background:var(--p); color:#fff">+</button>
            <button id="btn-exit" onclick="fullExit()" style="background:var(--sun); color:#fff; border:none; padding:6px 8px; border-radius:6px; font-weight:bold; cursor:pointer; font-size:10px">EXIT</button>
        </div>
    </div>
    <div class="date-panel">
        <select id="mS" onchange="render()"></select>
        <select id="yS" onchange="render()"></select>
    </div>
    <div class="view">
        <table>
            <thead><tr id="hRow"><th class="cw" id="th-m">–ú–ê–°–¢–ï–†</th><th class="ct" id="th-t">–ò–¢–û–ì–û</th></tr></thead>
            <tbody id="tBody"></tbody>
        </table>
    </div>
    <div class="total-footer" id="totalFooter">0 TJS</div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, signOut } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

    const firebaseConfig = { 
        apiKey: "AIzaSyBwc9X7c_8UHCb1KlKBLzwbBWHlf22s7a8", 
        authDomain: "dizel-8f122.firebaseapp.com", 
        projectId: "dizel-8f122", 
        storageBucket: "dizel-8f122.firebasestorage.app", 
        messagingSenderId: "648148623489", 
        appId: "1:648148623489:web:193a3b9df407c5babfed80" 
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const provider = new GoogleAuthProvider();
    provider.setCustomParameters({ prompt: 'select_account' });

    let mode = 'local', userUid = 'local_user', pinCode = null, workers = [], curL = 'ru';

    const dict = {
        ru: { m: "–ú–ê–°–¢–ï–†", t: "–ò–¢–û–ì–û", h: "–ß", d: "–î", r: "–°—Ç", ph: "–ò–º—è –º–∞—Å—Ç–µ—Ä–∞", exit: "–í–´–•–û–î", pinT: "–í–≤–µ–¥–∏—Ç–µ PIN", pinN: "–ù–æ–≤—ã–π PIN", enter: "–í–•–û–î", adv: "–ê–≤–∞–Ω—Å:", qh: "–ß–∞—Å—ã:", mo: ["–Ø–Ω–≤–∞—Ä—å","–§–µ–≤—Ä–∞–ª—å","–ú–∞—Ä—Ç","–ê–ø—Ä–µ–ª—å","–ú–∞–π","–ò—é–Ω—å","–ò—é–ª—å","–ê–≤–≥—É—Å—Ç","–°–µ–Ω—Ç—è–±—Ä—å","–û–∫—Ç—è–±—Ä—å","–ù–æ—è–±—Ä—å","–î–µ–∫–∞–±—Ä—å"], total: "–ò–¢–û–ì–û –ó–ê–†–ü–õ–ê–¢–ê:", rep: "REPORT FOR" },
        tj: { m: "–£–°–¢–û", t: "“∂–ê–™–ú", h: "–°", d: "–†", r: "–ù", ph: "–ù–æ–º–∏ —É—Å—Ç–æ", exit: "–•–£–†–£“∂", pinT: "–†–∞–º–∑", pinN: "–†–∞–º–∑–∏ –Ω–∞–≤", enter: "–í–û–†–£–î", adv: "–ê–≤–∞–Ω—Å:", qh: "–°–æ–∞—Ç:", mo: ["–Ø–Ω–≤–∞—Ä","–§–µ–≤—Ä–∞–ª","–ú–∞—Ä—Ç","–ê–ø—Ä–µ–ª","–ú–∞–π","–ò—é–Ω","–ò—é–ª","–ê–≤–≥—É—Å—Ç","–°–µ–Ω—Ç—è–±—Ä","–û–∫—Ç—è–±—Ä","–ù–æ—è–±—Ä","–î–µ–∫–∞–±—Ä"], total: "“∂–ê–™–ú–ò –ú–ê–û–®:", rep: "REPORT FOR" },
        en: { m: "MASTER", t: "TOTAL", h: "H", d: "D", r: "R", ph: "Name", exit: "EXIT", pinT: "PIN", pinN: "New PIN", enter: "LOGIN", adv: "Adv:", qh: "Hours:", mo: ["January","February","March","April","May","June","July","August","September","October","November","December"], total: "TOTAL SALARY:", rep: "REPORT FOR" }
    };

    // –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π —Å–ø–∏—Å–æ–∫ –º–µ—Å—è—Ü–µ–≤ –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º –¥–ª—è PDF
    const engMonths = ["JANUARY", "FEBRUARY", "MARCH", "APRIL", "MAY", "JUNE", "JULY", "AUGUST", "SEPTEMBER", "OCTOBER", "NOVEMBER", "DECEMBER"];

    window.toggleTheme = () => document.getElementById('mainBody').classList.toggle('light');
    window.fN = (n) => Math.round(n || 0).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
    
    window.authLocal = () => { mode = 'local'; localStorage.setItem('user_mode', 'local'); checkPinSetup(); }
    document.getElementById('btn-google').onclick = async () => {
        try {
            const result = await signInWithPopup(auth, provider);
            mode = 'cloud'; userUid = result.user.uid;
            localStorage.setItem('user_mode', 'cloud'); localStorage.setItem('user_uid', result.user.uid);
            await checkPinSetup();
        } catch (e) { alert("–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞!"); }
    };

    window.fullExit = () => { localStorage.clear(); signOut(auth).then(() => location.reload()); };

    async function checkPinSetup() {
        pinCode = null;
        if(mode === 'local') pinCode = localStorage.getItem('mp_pin');
        else { const ds = await getDoc(doc(db, "users", userUid)); if(ds.exists()) pinCode = ds.data().pin; }
        document.getElementById('screen-login').classList.add('hidden');
        document.getElementById('screen-pin').classList.remove('hidden');
        document.getElementById('pin-title').innerText = pinCode ? dict[curL].pinT : dict[curL].pinN;
    }

    window.checkPin = async function() {
        const v = document.getElementById('pin-input').value;
        if(!v) return;
        if(!pinCode) { pinCode = v; if(mode==='local') localStorage.setItem('mp_pin',v); else await setDoc(doc(db,"users",userUid),{pin:v}); await loadData(); }
        else { if(v === pinCode) await loadData(); else alert("–ù–µ–≤–µ—Ä–Ω—ã–π PIN!"); }
    }

    async function loadData() {
        document.getElementById('screen-pin').classList.add('hidden');
        document.getElementById('screen-app').classList.remove('hidden');
        if(mode === 'local') workers = JSON.parse(localStorage.getItem('mp_data')) || [];
        else { const ds = await getDoc(doc(db,"data",userUid)); workers = ds.exists() ? (ds.data().w || []) : []; }
        render();
    }

    window.setLang = (l) => {
        curL = l;
        document.querySelectorAll('.l-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('l-'+l).classList.add('active');
        document.getElementById('th-m').innerText = dict[l].m;
        document.getElementById('th-t').innerText = dict[l].t;
        document.getElementById('btn-exit').innerText = dict[l].exit;
        
        const mS = document.getElementById('mS');
        const currentSelectedMonth = mS.value !== "" ? mS.value : new Date().getMonth();
        mS.innerHTML = '';
        dict[l].mo.forEach((mName, i) => {
            let opt = new Option(mName, i);
            if(i == currentSelectedMonth) opt.selected = true;
            mS.add(opt);
        });
        render();
    }

    window.addW = () => { let n = prompt(dict[curL].ph); if(n) { workers.push({n:n, r:170, d:{}}); saveData(); } }

    window.render = function() {
        const mS = document.getElementById('mS');
        const yS = document.getElementById('yS');
        if(!mS.options.length) return;

        const y = yS.value, m = mS.value;
        const days = new Date(y, parseInt(m)+1, 0).getDate();
        const hr = document.getElementById('hRow');
        
        while(hr.children.length > 2) hr.removeChild(hr.children[1]);
        for(let d=1; d<=days; d++) { 
            let th = document.createElement('th'); th.className='cd'; th.innerText=d; 
            if(new Date(y, parseInt(m), d).getDay() === 0) th.classList.add('sunday');
            hr.insertBefore(th, hr.children[d]); 
        }
        
        const tb = document.getElementById('tBody'); tb.innerHTML = '';
        let grandTotal = 0;
        
        workers.forEach((w, idx) => {
            let total = 0, hours = 0;
            for(let d=1; d<=days; d++) {
                let k=`${y}_${m}_${d}`, h=w.d[k]?.h||0, a=w.d[k]?.a||0;
                let cH = h > 0 ? h : 0; hours += cH; total += (cH * (w.r/8)) - a;
            }
            let dVal = (hours / 8).toFixed(1).replace('.0', '');
            
            let html = `<td class="cw">${w.n}<br><small>${dict[curL].h}:${hours} | ${dict[curL].d}:${dVal}</small><br><input type="number" value="${w.r}" onchange="updR(${idx},this.value)"><br><span onclick="delW(${idx})" style="color:var(--sun);cursor:pointer;font-size:9px">–£–î–ê–õ–ò–¢–¨</span></td>`;
            for(let d=1; d<=days; d++) {
                let k=`${y}_${m}_${d}`, h=w.d[k]?.h||0, a=w.d[k]?.a||0;
                let cellClass = h === 8 ? 'on' : (h === -1 ? 'off' : '');
                let cellText = (h > 0 && h !== 8) ? h : '';
                html += `<td class="cd ${new Date(y, parseInt(m), d).getDay()===0?'sunday':''}">
                    <div class="sq-h ${cellClass}" onclick="setH(${idx},'${k}')" oncontextmenu="setCus(event,${idx},'${k}')">${cellText}</div>
                    <div class="sq-a ${a>0?'on':''}" onclick="setA(${idx},'${k}')">${a>0?a:'$'}</div>
                </td>`;
            }
            html += `<td class="ct">${fN(total)}</td>`;
            let row = document.createElement('tr'); row.innerHTML = html; tb.appendChild(row);
            grandTotal += total;
        });
        document.getElementById('totalFooter').innerText = `${dict[curL].total} ${fN(grandTotal)} TJS`;
    }

    window.saveData = async () => { if(mode==='local') localStorage.setItem('mp_data',JSON.stringify(workers)); else await setDoc(doc(db,"data",userUid),{w:workers}); render(); }
    window.updR = (i,v) => { workers[i].r = v; saveData(); }
    window.delW = (i) => { if(confirm('–£–¥–∞–ª–∏—Ç—å?')) { workers.splice(i,1); saveData(); } }
    window.setH = (i,k) => { if(!workers[i].d[k]) workers[i].d[k]={}; let cur = workers[i].d[k].h || 0; workers[i].d[k].h = (cur === 0) ? 8 : (cur === 8 ? -1 : 0); saveData(); }
    window.setCus = (e,i,k) => { e.preventDefault(); let v = prompt(dict[curL].qh); if(v !== null) { if(!workers[i].d[k]) workers[i].d[k]={}; workers[i].d[k].h = parseInt(v) || 0; saveData(); } }
    window.setA = (i,k) => { let v=prompt(dict[curL].adv); if(v!==null){ if(!workers[i].d[k])workers[i].d[k]={}; workers[i].d[k].a=parseFloat(v)||0; saveData(); } }

    window.genPDF = () => {
        const { jsPDF } = window.jspdf;
        const docP = new jsPDF('l', 'mm', 'a4');
        const y = document.getElementById('yS').value, m = document.getElementById('mS').value;
        
        // –ë–µ—Ä–µ–º –º–µ—Å—è—Ü –∏–∑ –∞–Ω–≥–ª–∏–π—Å–∫–æ–≥–æ —Å–ø–∏—Å–∫–∞
        const monthNameEng = engMonths[m];
        
        const trN = (s) => {
            const map = {'–∞':'a','–±':'b','–≤':'v','–≥':'g','–¥':'d','–µ':'e','—ë':'yo','–∂':'zh','–∑':'z','–∏':'i','–π':'j','–∫':'k','–ª':'l','–º':'m','–Ω':'n','–æ':'o','–ø':'p','—Ä':'r','—Å':'s','—Ç':'t','—É':'u','—Ñ':'f','—Ö':'kh','—Ü':'ts','—á':'ch','—à':'sh','—â':'sch','—ã':'y','—ç':'e','—é':'yu','—è':'ya','“∑':'j','“õ':'q','“≥':'h','”Ø':'u','“ì':'gh'};
            return s.toLowerCase().split('').map(c => map[c] || c).join('').toUpperCase();
        };

        docP.setFontSize(18);
        docP.setTextColor(249, 115, 22);
        
        // –ó–∞–≥–æ–ª–æ–≤–æ–∫ PDF –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º
        docP.text(`SUGD BETON: REPORT FOR ${monthNameEng} ${y}`, 148, 15, {align:"center"});
        
        let grandTotal = 0;
        let rows = workers.map(w => {
            let t=0, hs=0, adv=0; 
            for(let d=1; d<=new Date(y, parseInt(m)+1, 0).getDate(); d++){
                let k = `${y}_${m}_${d}`, h = w.d[k]?.h || 0, a = w.d[k]?.a || 0;
                let cH = h > 0 ? h : 0; hs += cH; adv += a;
                t += (cH * (w.r/8)) - a;
            }
            grandTotal += t;
            return [trN(w.n), w.r, hs, (hs/8).toFixed(1).replace('.0',''), fN(adv), fN(t) + " TJS"];
        });

        rows.push([{ content: 'GRAND TOTAL:', colSpan: 5, styles: { halign: 'right', fontStyle: 'bold' } }, { content: fN(grandTotal) + " TJS", styles: { fontStyle: 'bold', fillColor: [249, 115, 22], textColor: 255 } }]);

        docP.autoTable({ 
            head: [['Master Name', 'Rate/D', 'Hours', 'Days(8h)', 'Advance', 'Total']], 
            body: rows, 
            startY: 25, 
            theme: 'grid', 
            headStyles: { fillColor: [249, 115, 22], halign: 'center' },
            styles: { fontSize: 10, halign: 'center' },
            columnStyles: { 0: { halign: 'left' } }
        });
        
        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ñ–∞–π–ª–∞ —Å –∞–Ω–≥–ª–∏–π—Å–∫–∏–º –Ω–∞–∑–≤–∞–Ω–∏–µ–º –º–µ—Å—è—Ü–∞
        docP.save(`Sugd_Beton_${monthNameEng}_${y}.pdf`);
    }

    const yS=document.getElementById('yS');
    for(let y=2025; y<=2028; y++) yS.add(new Option(y, y, false, y===new Date().getFullYear()));

    if(localStorage.getItem('user_mode')) { 
        mode = localStorage.getItem('user_mode'); 
        userUid = localStorage.getItem('user_uid') || 'local_user'; 
        checkPinSetup(); 
    }
    setLang('ru');
</script>
</body>
</html>
